name: Deploy existing artifact to Nexus

on:
  workflow_dispatch:
    inputs:
      # GitHub download info
      source_repo:
        description: "GitHub repo to download from (owner/repo)"
        required: true
        default: "turbo5000c/tomcat-root-war"
      run_id:
        description: "the Run ID in the build"
        required: true
        default: "20242170031"
        
      # Paths
      pom_path:
        description: "Path to pom.xml in this repo"
        required: true
        default: "pom.xml"
      target_dir:
        description: "Path to pom.xml in this repo"
        required: true
        default: "target"      
      download_dir:
        description: "Directory to download artifact into"
        required: true
        default: "artifact"

      # Nexus
      nexus_repo_url:
        description: "Nexus repository URL (e.g. https://nexus.local.xyz/repository/releases)"
        required: true
        default: "https://nexus.local.updawg.xyz/repository/maven-releases/"
      nexus_repo_id:
        description: "Maven server id (matches settings.xml)"
        required: true
        default: "nexus"

jobs:
  deploy:
    runs-on: tomcat
    
    permissions:
      contents: read

    steps:
      - name: Checkout (for pom.xml)
        uses: actions/checkout@v4

      - name: Set up JDK 17 + Maven settings for Nexus
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: temurin
          server-id: ${{ inputs.nexus_repo_id }}
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD
          settings-path: ${{ github.workspace }}


      - name: Download artifact from GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p "${{ inputs.download_dir }}"

          
          gh run download $ARTIFACT_RUN_ID \
          --repo $GITHUB_ORG_REPO \
          --name "$ARTIFACT_NAME" \
          --dir "${{ inputs.download_dir }}"
          
          echo "Downloaded files:"
          ls -l "${{ inputs.download_dir }}"

      - name: Verify files
        run: |
          set -euo pipefail

          ARTIFACT_PATH="${{ inputs.download_dir }}/${{ inputs.target_dir }}"
          POM_PATH="${{ inputs.download_dir }}/${{ inputs.pom_path }}"

          echo "Artifact path: $ARTIFACT_PATH"
          ls -l $ARTIFACT_PATH
          
          echo "POM path:      $POM_PATH"
          ls -l $POM_PATH

          if [[ ! -f "$ARTIFACT_PATH" ]]; then
            echo "ERROR: Artifact not found"
            exit 1
          fi
          
          ls -l $POM_PATH
          if [[ ! -f "$POM_PATH" ]]; then
            echo "ERROR: pom.xml not found"
            exit 1
          fi

      - name: Deploy artifact to Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -euo pipefail

          ARTIFACT_PATH="${{ inputs.download_dir }}/${{ inputs.asset_name }}"

          MVN_ARGS=(
            -B
            --settings "$GITHUB_WORKSPACE/settings.xml"
            deploy:deploy-file
            "-Durl=${{ inputs.nexus_repo_url }}"
            "-DrepositoryId=${{ inputs.nexus_repo_id }}"
            "-DgroupId=${{ inputs.group_id }}"
            "-DartifactId=${{ inputs.artifact_id }}"
            "-Dversion=${{ inputs.version }}"
            "-Dpackaging=${{ inputs.packaging }}"
            "-Dfile=$ARTIFACT_PATH"
            "-DpomFile=${{ inputs.pom_path }}"
            "-DgeneratePom=false"
          )

          if [[ -n "${{ inputs.classifier }}" ]]; then
            MVN_ARGS+=("-Dclassifier=${{ inputs.classifier }}")
          fi

          mvn "${MVN_ARGS[@]}"
