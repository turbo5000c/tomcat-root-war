name: Deploy existing artifact to Nexus

on:
  workflow_dispatch:
    inputs:
      # GitHub download info
      source_repo:
        description: "GitHub repo to download from (owner/repo)"
        required: true
      release_tag:
        description: "Release tag (e.g. v1.2.3)"
        required: true
      asset_name:
        description: "Exact asset filename to download (e.g. my-app-1.2.3.jar)"
        required: true

      # Maven coordinates
      group_id:
        description: "groupId (e.g. com.acme)"
        required: true
      artifact_id:
        description: "artifactId (e.g. my-app)"
        required: true
      version:
        description: "version (e.g. 1.2.3)"
        required: true
      packaging:
        description: "packaging (jar, war, pom, etc.)"
        required: true
        default: "jar"
      classifier:
        description: "optional classifier (leave blank if none)"
        required: false
        default: ""

      # Paths
      pom_path:
        description: "Path to pom.xml in this repo"
        required: true
        default: "pom.xml"
      download_dir:
        description: "Directory to download artifact into"
        required: true
        default: "artifact"

      # Nexus
      nexus_repo_url:
        description: "Nexus repository URL (e.g. https://nexus.local.xyz/repository/releases)"
        required: true
      nexus_repo_id:
        description: "Maven server id (matches settings.xml)"
        required: true
        default: "nexus"

jobs:
  deploy:
    runs-on: tomcat
    
    permissions:
      contents: read

    steps:
      - name: Checkout (for pom.xml)
        uses: actions/checkout@v4

      - name: Set up JDK 17 + Maven settings for Nexus
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: temurin
          server-id: ${{ inputs.nexus_repo_id }}
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD
          settings-path: ${{ github.workspace }}

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Download artifact from GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p "${{ inputs.download_dir }}"

          gh release download "${{ inputs.release_tag }}" \
            --repo "${{ inputs.source_repo }}" \
            --pattern "${{ inputs.asset_name }}" \
            --dir "${{ inputs.download_dir }}"

          echo "Downloaded files:"
          ls -l "${{ inputs.download_dir }}"

      - name: Verify files
        run: |
          set -euo pipefail

          ARTIFACT_PATH="${{ inputs.download_dir }}/${{ inputs.asset_name }}"
          POM_PATH="${{ inputs.download_dir }}/${{ inputs.pom_path }}"

          echo "Artifact path: $ARTIFACT_PATH"
          echo "POM path:      $POM_PATH"

          if [[ ! -f "$ARTIFACT_PATH" ]]; then
            echo "ERROR: Artifact not found"
            exit 1
          fi

          if [[ ! -f "$POM_PATH" ]]; then
            echo "ERROR: pom.xml not found"
            exit 1
          fi

      - name: Deploy artifact to Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -euo pipefail

          ARTIFACT_PATH="${{ inputs.download_dir }}/${{ inputs.asset_name }}"

          MVN_ARGS=(
            -B
            --settings "$GITHUB_WORKSPACE/settings.xml"
            deploy:deploy-file
            "-Durl=${{ inputs.nexus_repo_url }}"
            "-DrepositoryId=${{ inputs.nexus_repo_id }}"
            "-DgroupId=${{ inputs.group_id }}"
            "-DartifactId=${{ inputs.artifact_id }}"
            "-Dversion=${{ inputs.version }}"
            "-Dpackaging=${{ inputs.packaging }}"
            "-Dfile=$ARTIFACT_PATH"
            "-DpomFile=${{ inputs.pom_path }}"
            "-DgeneratePom=false"
          )

          if [[ -n "${{ inputs.classifier }}" ]]; then
            MVN_ARGS+=("-Dclassifier=${{ inputs.classifier }}")
          fi

          mvn "${MVN_ARGS[@]}"
